using AloneWar.Common;
using AloneWar.DataObject.Sqlite.SqliteObject.Base;
using AloneWar.Stage.Component;
using AloneWar.Stage.FieldObject;
using AloneWar.Unit.Component;
using System.Collections.Generic;
using System.Linq;
using UnityEngine;

namespace AloneWar.Stage.Controller.Unit
{
    /// <summary>
    /// 
    /// </summary>
    public class UnitRange<T> where T : SqliteBaseData
    {
        #region property

        private UnitBaseComponent<T> UnitBaseComponent { get; set; }

        private int MainRange { get; set; }

        private int SubRange { get; set; }

        private int InvaildMainRange { get; set; }

        private int InvaildSubRange { get; set; }

        private CommandCategory MainCommandCategory { get; set; }

        private CommandCategory SubCommandCategory { get; set; }

        /// <summary>
        /// key is positionId
        /// </summary>
        public Dictionary<int, RangeCommand> MainRangeCommandList { get { return this.mainCommandList; } set { this.mainCommandList = value; } }
        private Dictionary<int, RangeCommand> mainCommandList = new Dictionary<int, RangeCommand>();

        /// <summary>
        /// key is positionId
        /// </summary>
        public Dictionary<int, RangeCommand> SubRangeCommandList { get { return this.subCommandList; } set { this.subCommandList = value; } }
        private Dictionary<int, RangeCommand> subCommandList = new Dictionary<int, RangeCommand>();

        #endregion

        /// <summary>
        /// コンストラクタ
        /// </summary>
        /// <param name="unitBaseStatus"></param>
        /// <param name="monoBehaviour"></param>
        public UnitRange(UnitBaseComponent<T> unitBaseComponent)
        {
            this.UnitBaseComponent = unitBaseComponent;
            this.InitRange();
        }

        #region Range

        /// <summary>
        /// 空初期化
        /// </summary>
        public void InitRange()
        {
            this.MainRange = 0;
            this.SubRange = 0;
            this.InvaildMainRange = 0;
            this.InvaildSubRange = 0;
            this.MainCommandCategory = CommandCategory.None;
            this.SubCommandCategory = CommandCategory.None;
            this.MainRangeCommandList.Clear();
            this.SubRangeCommandList.Clear(); ;
        }

        /// <summary>
        /// 初期化
        /// </summary>
        public void InitRange(CommandCategory mainCommand, CommandCategory subCommand, int mainRange, int subRange, int invalidMainRange, int invaildSubRange)
        {
            this.MainRange = mainRange;
            this.SubRange = subRange;
            this.InvaildMainRange = invalidMainRange;
            this.InvaildSubRange = invaildSubRange;
            this.MainCommandCategory = mainCommand;
            this.SubCommandCategory = subCommand;
            this.MainRangeCommandList.Clear();
            this.SubRangeCommandList.Clear();
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="mainCommand"></param>
        /// <param name="subCommand"></param>
        /// <param name="mainRange"></param>
        /// <param name="subRange"></param>
        /// <param name="invalidMainRange"></param>
        /// <param name="invaildSubRange"></param>
        public void SetRange(CommandCategory mainCommand, CommandCategory subCommand, int mainRange, int subRange, int invalidMainRange = 0, int invaildSubRange = 0)
        {
            this.InitRange(mainCommand, subCommand, mainRange, subRange, invalidMainRange, invaildSubRange);
            int positionId = this.UnitBaseComponent.UnitObjectStatus.StageStatus.PositionId;

            RangeCommand massRange = new RangeCommand(this.UnitBaseComponent.UnitObjectStatus.StageStatus.UnitSide, positionId, this.MainRange, this.InvaildMainRange);
            List<RangeCommand> mainRangeCommandList = new List<RangeCommand>(new RangeCommand[] { massRange });
            List<RangeCommand> subRangeCommandList = new List<RangeCommand>();
            this.MainRangeCommandList.Add(positionId, massRange);
            this.SetRangeLoop(mainRangeCommandList, subRangeCommandList);
            this.SetRangeLoop(subRangeCommandList, new List<RangeCommand>());
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="rangeCommandList0"></param>
        /// <param name="rangeCommandList1"></param>
        private void SetRangeLoop(List<RangeCommand> rangeCommandList0, List<RangeCommand> rangeCommandList1)
        {
            // ループ用リスト
            List<RangeCommand> rangeCommandNext = new List<RangeCommand>();
            int w = StageManager.Instance.StageInformation.StageData.Width;
            rangeCommandList0.ForEach(m =>
            {
                MassStatus massStatus = m.MassComponent.MassStatus;
                // top
                RangeCommand upRange = new RangeCommand(m, massStatus.PositionId - w, RangeDirection.Top);
                if (this.AddRangeIfVaild(upRange, rangeCommandList0, rangeCommandList1))
                {
                    rangeCommandNext.Add(upRange);
                }
                // bottom
                RangeCommand bottomRange = new RangeCommand(m, massStatus.PositionId + w, RangeDirection.Bottom);
                if (this.AddRangeIfVaild(bottomRange, rangeCommandList0, rangeCommandList1))
                {
                    rangeCommandNext.Add(bottomRange);
                }
                // right
                RangeCommand rightRange = new RangeCommand(m, massStatus.PositionId + 1, RangeDirection.Right);
                if (this.AddRangeIfVaild(rightRange, rangeCommandList0, rangeCommandList1))
                {
                    rangeCommandNext.Add(rightRange);
                }
                // left
                RangeCommand leftRange = new RangeCommand(m, massStatus.PositionId - 1, RangeDirection.Left);
                if (this.AddRangeIfVaild(rightRange, rangeCommandList0, rangeCommandList1))
                {
                    rangeCommandNext.Add(leftRange);
                }
            });
            // 再帰処理
            this.SetRangeLoop(rangeCommandNext, rangeCommandList1);
        }

        /// <summary>
        /// 対象マスを0範囲に追加
        /// 有効でない場合は1範囲に追加
        /// </summary>
        /// <param name="rangeCommand"></param>
        /// <param name="rangeCommandList0"></param>
        /// <param name="rangeCommandList1"></param>
        private bool AddRangeIfVaild(RangeCommand rangeCommand, List<RangeCommand> rangeCommandList0, List<RangeCommand> rangeCommandList1)
        {
            if (!this.MainRangeCommandList.ContainsKey(rangeCommand.MassComponent.PositionId) && !this.SubRangeCommandList.ContainsKey(rangeCommand.MassComponent.PositionId))
            {
                if (rangeCommand.IsVaildRange && rangeCommand.IsVaildRangeUnit)
                {
                    rangeCommandList0.Add(rangeCommand);
                    return true;
                }
                else
                {
                    RangeCommand subRange = new RangeCommand(rangeCommand, this.SubCommandCategory, this.SubRange, this.InvaildSubRange);
                    rangeCommandList1.Add(subRange);
                }
            }

            return false;
        }

        /// <summary>
        /// 
        /// </summary>
        public void SetRangeColor()
        {
            this.MainRangeCommandList.ToList().ForEach(pair =>
            {
                RangeCommand rangeCommand = this.MainRangeCommandList[pair.Key];
                MassComponent massComponent = rangeCommand.MassComponent;
                //rangeCommand.CommandCategory より色を決定
                massComponent.GetComponent<SpriteRenderer>().color = new UnityEngine.Color();
            });

            this.SubRangeCommandList.ToList().ForEach(pair =>
            {
                RangeCommand rangeCommand = this.SubRangeCommandList[pair.Key];
                MassComponent massComponent = rangeCommand.MassComponent;
                //rangeCommand.CommandCategory より色を決定
                massComponent.GetComponent<SpriteRenderer>().color = new UnityEngine.Color();
            });
        }

        /// <summary>
        /// 対象座標を範囲に含んでいた場合、範囲を再設定する
        /// </summary>
        /// <param name="positionId"></param>
        /// <returns></returns>
        public void ResetRange(int positionId)
        {
            if (this.MainRangeCommandList.ContainsKey(positionId))
            {
                this.SetRange(this.UnitBaseComponent.UnitObjectStatus.MainCommand, this.UnitBaseComponent.UnitObjectStatus.SubCommand, this.UnitBaseComponent.MainRange, this.UnitBaseComponent.SubRange, 0, this.UnitBaseComponent.UnitObjectStatus.BaseStatus.InvalidRange);
            }
        }

        #endregion

        /// <summary>
        /// 
        /// </summary>
        /// <returns></returns>
        public UnitSummaryComponent SearchRange()
        {
            UnitSummaryComponent unitSummaryComponent = new UnitSummaryComponent();
            List<int> mainKeys = this.MainRangeCommandList.Keys.ToList();
            List<int> subKeys = this.SubRangeCommandList.Keys.ToList();
            mainKeys.AddRange(subKeys);

            return StageManager.Instance.StageInformation.SearchUnitComponent(mainKeys);
        }
    }
}
